<!DOCTYPE html>
<html>
<head>
    <title>Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 p-8 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto relative">
        <div class="fixed bottom-5 right-5 z-50 flex flex-col gap-2">
            <div v-for="t in toasts" :key="t.id" :class="t.type=='error'?'bg-red-500':'bg-green-500'" class="text-white px-6 py-3 rounded shadow" v-text="t.msg"></div>
        </div>

        <header class="mb-8 flex justify-between items-center relative z-10">
            <h1 class="text-2xl font-bold">Ollama Proxy</h1>
            <div class="relative group">
                <button class="flex items-center gap-2 font-bold text-blue-600 hover:text-blue-800 py-2">
                    <span v-text="user"></span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="absolute right-0 w-40 bg-white border border-gray-200 rounded shadow-lg hidden group-hover:block hover:block">
                    <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 border-b">修改密码</a>
                    <a href="/logout" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">退出登录</a>
                </div>
            </div>
        </header>

        <section class="bg-white p-6 rounded shadow mb-8">
            <h2 class="font-bold mb-4">服务配置</h2>
            <input v-model="config.host" class="w-full p-2 border rounded mb-2" placeholder="Ollama URL">
            <input v-model="config.key" type="password" class="w-full p-2 border rounded mb-2" placeholder="API Key (Optional)">
            <div class="flex justify-end gap-2">
                <button @click="testConn" :disabled="loading" class="bg-blue-600 text-white px-4 py-2 rounded" v-text="loading?'检测中...':'测试连接'"></button>
                <button @click="saveConf" class="bg-slate-800 text-white px-4 py-2 rounded">保存</button>
            </div>
            <div v-if="models.length" class="mt-4 p-4 bg-green-50 rounded text-sm text-green-800">
                <p class="font-bold mb-2">可用模型:</p>
                <span v-for="m in models" class="mr-2 mb-2 inline-block bg-white border px-2 py-1 rounded" v-text="m"></span>
            </div>
        </section>

        <section class="bg-white p-6 rounded shadow">
            <h2 class="font-bold mb-4">API Keys</h2>
            <div class="flex gap-2 mb-4">
                <input v-model="newKey" class="flex-1 p-2 border rounded" placeholder="请输入备注名称 (必填)">
                <button @click="addKey" class="bg-green-600 text-white px-4 py-2 rounded">生成 Key</button>
            </div>
            <div v-for="k in keys" class="flex justify-between border-b py-2 text-sm">
                <span v-text="k.name"></span>
                <code class="bg-slate-100 px-2 rounded cursor-pointer select-all" @click="copy(k.key)" v-text="k.key"></code>
                <span class="text-gray-500" v-text="k.created_at"></span>
                <button @click="delKey(k.key)" class="text-red-500">撤销</button>
            </div>
        </section>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    user: "{{ username }}",
                    config: { host: "{{ ollama_host }}", key: "{{ ollama_key }}" },
                    keys: {{ keys|tojson }},
                    newKey: '',
                    models: [],
                    loading: false,
                    toasts: []
                }
            },
            methods: {
                toast(m, t='info') {
                    const id=Date.now();
                    this.toasts.push({id, msg:m, type:t});
                    setTimeout(()=>this.toasts=this.toasts.filter(x=>x.id!==id),3000);
                },
                async saveConf(s=false) {
                    const fd=new FormData(); fd.append('ollama_host', this.config.host); fd.append('ollama_key', this.config.key||'');
                    try { if((await fetch('/admin/config',{method:'POST',body:fd})).ok && !s) this.toast('保存成功','ok'); } catch{ this.toast('保存失败','error'); }
                },
                async testConn() {
                    this.loading=true; this.models=[]; await this.saveConf(true);
                    try {
                        const res = await fetch('/api/test-connection', {method:'POST'}); const d=await res.json();
                        if(res.ok && d.status=='success') { this.toast(d.message,'ok'); this.models=d.models; } else this.toast(d.message||'失败','error');
                    } catch { this.toast('网络错误','error'); } finally { this.loading=false; }
                },
                async addKey() {
                    // 修复：如果没有输入备注，弹出提示而不是静默失败
                    if(!this.newKey) {
                        this.toast('请先输入备注名称！', 'error');
                        return;
                    }
                    const fd=new FormData(); fd.append('name', this.newKey);
                    const res = await fetch('/admin/keys', {method:'POST',body:fd});
                    if(res.ok) {
                        this.toast('Key 生成成功', 'ok');
                        setTimeout(() => location.reload(), 500);
                    } else {
                        this.toast('生成失败', 'error');
                    }
                },
                async delKey(k) { if(confirm('删除?')) { await fetch('/admin/keys/'+k, {method:'DELETE'}); location.reload(); } },
                copy(t) { navigator.clipboard.writeText(t); this.toast('已复制'); }
            }
        }).mount('#app')
    </script>
</body>
</html>
